
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><meta name="viewport" content="width=600, initial-scale=1">
    <title>Coding in Cython &#8212; Sage Developer&#39;s Guide v8.4</title>
    <link rel="stylesheet" href="_static/sage.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/MathJax.js?config=TeX-AMS_HTML-full,../mathjax_sage.js"></script>
    <script type="text/javascript" src="_static/MathJax.js?config=TeX-AMS_HTML-full,../mathjax_sage.js"></script>
    <script type="text/javascript" src="_static/MathJax.js?config=TeX-AMS_HTML-full,../mathjax_sage.js"></script>
    <link rel="shortcut icon" href="_static/favicon.ico"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Using External Libraries and Interfaces" href="coding_in_other.html" />
    <link rel="prev" title="Coding in Python for Sage" href="coding_in_python.html" />
    <link rel="icon" href="_static/sageicon.png" type="image/x-icon" />
    <script src="_static/thebe.js" type="text/javascript"></script>
    <script src="_static/thebe-sage.js" type="text/javascript"></script>

  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="coding_in_other.html" title="Using External Libraries and Interfaces"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="coding_in_python.html" title="Coding in Python for Sage"
             accesskey="P">previous</a> |</li>
  
    
      <a href="../index.html"><img src="_static/logo_sagemath_black.svg" height="28" style="vertical-align: middle" title="Sage Logo"></a>
    
  
  
        <li class="nav-item nav-item-0"><a href="index.html">Developer&#39;s Guide v8.4</a> &#187;</li>
 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="coding-in-cython">
<span id="chapter-cython"></span><h1>Coding in Cython<a class="headerlink" href="#coding-in-cython" title="Permalink to this headline">¶</a></h1>
<p>This chapter discusses Cython, which is a compiled language based on
Python.  The major advantage it has over Python is that code can be
much faster (sometimes orders of magnitude) and can directly call
C and C++ code.  As Cython is essentially a superset of the Python
language, one often doesn’t make a distinction between Cython and
Python code in Sage (e.g. one talks of the “Sage Python Library”
and “Python Coding Conventions”).</p>
<p>Python is an interpreted language and has no declared data types for
variables. These features make it easy to write and debug, but Python
code can sometimes be slow. Cython code can look a lot like Python,
but it gets translated into C code (often very efficient C code) and
then compiled. Thus it offers a language which is familiar to Python
developers, but with the potential for much greater speed. Cython also
allows Sage developers to interface with C and C++ much easier than
using the Python C API directly.</p>
<p>Cython is a compiled version of Python. It was originally based on
Pyrex but has changed based on what Sage’s developers needed; Cython
has been developed in concert with Sage. However, it is an independent
project now, which is used beyond the scope of Sage. As such, it is a
young, but developing language, with young, but developing
documentation. See its web page, <a class="reference external" href="http://www.cython.org/">http://www.cython.org/</a>, for the most
up-to-date information or check out the
<a class="reference external" href="http://docs.cython.org/src/userguide/language_basics.html">Language Basics</a>
to get started immediately.</p>
<div class="section" id="writing-cython-code-in-sage">
<h2>Writing Cython Code in Sage<a class="headerlink" href="#writing-cython-code-in-sage" title="Permalink to this headline">¶</a></h2>
<p>There are several ways to create and build Cython code in Sage.</p>
<ol class="arabic">
<li><p class="first">In the Sage Notebook, begin any cell with <code class="docutils literal notranslate"><span class="pre">%cython</span></code>. When you
evaluate that cell,</p>
<ol class="arabic">
<li><p class="first">It is saved to a file.</p>
</li>
<li><p class="first">Cython is run on it with all the standard Sage libraries
automatically linked if necessary.</p>
</li>
<li><p class="first">The resulting shared library file (<code class="docutils literal notranslate"><span class="pre">.so</span></code> / <code class="docutils literal notranslate"><span class="pre">.dll</span></code> /
<code class="docutils literal notranslate"><span class="pre">.dylib</span></code>) is then loaded into your running instance of Sage.</p>
</li>
<li><p class="first">The functionality defined in that cell is now available for you
to use in the notebook. Also, the output cell has a link to the C
program that was compiled to create the <code class="docutils literal notranslate"><span class="pre">.so</span></code> file.</p>
</li>
<li><p class="first">A <code class="docutils literal notranslate"><span class="pre">cpdef</span></code> or <code class="docutils literal notranslate"><span class="pre">def</span></code> function, say <code class="docutils literal notranslate"><span class="pre">testfunction</span></code>, defined in
a <code class="docutils literal notranslate"><span class="pre">%cython</span></code> cell in a worksheet can be imported and made available
in a different <code class="docutils literal notranslate"><span class="pre">%cython</span></code> cell within the same worksheet by
importing it as shown below:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="n">cython</span>
<span class="kn">from</span> <span class="nn">__main__</span> <span class="k">import</span> <span class="n">testfunction</span>
</pre></div>
</div>
</li>
</ol>
</li>
<li><p class="first">Create an <code class="docutils literal notranslate"><span class="pre">.spyx</span></code> file and attach or load it from the command
line. This is similar to creating a <code class="docutils literal notranslate"><span class="pre">%cython</span></code> cell in the
notebook but works completely from the command line (and not from
the notebook).</p>
</li>
<li><p class="first">Create a <code class="docutils literal notranslate"><span class="pre">.pyx</span></code> file and add it to the Sage library.</p>
<ol class="arabic simple">
<li>First, add a listing for the Cython extension to the variable
<code class="docutils literal notranslate"><span class="pre">ext_modules</span></code> in the file
<code class="docutils literal notranslate"><span class="pre">SAGE_ROOT/src/module_list.py</span></code>. See the
<code class="docutils literal notranslate"><span class="pre">distutils.extension.Extension</span></code> class for more information on
creating a new Cython extension.</li>
<li>Run <code class="docutils literal notranslate"><span class="pre">sage</span> <span class="pre">-b</span></code> to rebuild Sage.</li>
</ol>
<p>For example, in order to compile
<code class="docutils literal notranslate"><span class="pre">SAGE_ROOT/src/sage/graphs/chrompoly.pyx</span></code>, we see the following
lines in <code class="docutils literal notranslate"><span class="pre">module_list.py</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Extension</span><span class="p">(</span><span class="s1">&#39;sage.graphs.chrompoly&#39;</span><span class="p">,</span>
          <span class="n">sources</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sage/graphs/chrompoly.pyx&#39;</span><span class="p">],</span>
          <span class="n">libraries</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;gmp&#39;</span><span class="p">]),</span>
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="attaching-or-loading-spyx-files">
<h2>Attaching or Loading .spyx Files<a class="headerlink" href="#attaching-or-loading-spyx-files" title="Permalink to this headline">¶</a></h2>
<p>The easiest way to try out Cython without having to learn anything
about distutils, etc., is to create a file with the extension
<code class="docutils literal notranslate"><span class="pre">spyx</span></code>, which stands for “Sage Pyrex”:</p>
<ol class="arabic">
<li><p class="first">Create a file <code class="docutils literal notranslate"><span class="pre">power2.spyx</span></code>.</p>
</li>
<li><p class="first">Put the following in it:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">is2pow</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">while</span> <span class="n">n</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">n</span><span class="o">%</span><span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">n</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span>
</pre></div>
</div>
</li>
<li><p class="first">Start the Sage command line interpreter and load the <code class="docutils literal notranslate"><span class="pre">spyx</span></code> file
(this will fail if you do not have a C compiler installed).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;power2.spyx&quot;</span><span class="p">)</span>
<span class="go">Compiling power2.spyx...</span>
<span class="gp">sage: </span><span class="n">is2pow</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
<span class="go">False</span>
</pre></div>
</div>
</li>
</ol>
<p>Note that you can change <code class="docutils literal notranslate"><span class="pre">power2.spyx</span></code>, then load it again and it
will be recompiled on the fly. You can also attach <code class="docutils literal notranslate"><span class="pre">power2.spyx</span></code> so
it is reloaded whenever you make changes:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="n">attach</span><span class="p">(</span><span class="s2">&quot;power2.spyx&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Cython is used for its speed. Here is a timed test on a 2.6 GHz
Opteron:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="o">%</span><span class="n">time</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="o">^</span><span class="mi">5</span><span class="p">)</span> <span class="k">if</span> <span class="n">is2pow</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
<span class="go">[1, 2, 4, 8, 16, 32, 64, 128, 256, 512, 1024, 2048, 4096, 8192, 16384, 32768, 65536]</span>
<span class="go">CPU times: user 0.60 s, sys: 0.00 s, total: 0.60 s</span>
<span class="go">Wall time: 0.60 s</span>
</pre></div>
</div>
<p>Now, the code in the file <code class="docutils literal notranslate"><span class="pre">power2.spyx</span></code> is valid Python, and if we
copy this to a file <code class="docutils literal notranslate"><span class="pre">powerslow.py</span></code> and load that, we get the
following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;powerslow.py&quot;</span><span class="p">)</span>
<span class="gp">sage: </span><span class="o">%</span><span class="n">time</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="o">^</span><span class="mi">5</span><span class="p">)</span> <span class="k">if</span> <span class="n">is2pow</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
<span class="go">[1, 2, 4, 8, 16, 32, 64, 128, 256, 512, 1024, 2048, 4096, 8192, 16384, 32768, 65536]</span>
<span class="go">CPU times: user 1.01 s, sys: 0.04 s, total: 1.05 s</span>
<span class="go">Wall time: 1.05 s</span>
</pre></div>
</div>
<p>By the way, we could gain even a little more speed with the Cython
version with a type declaration, by changing <code class="docutils literal notranslate"><span class="pre">def</span> <span class="pre">is2pow(n):</span></code> to
<code class="docutils literal notranslate"><span class="pre">def</span> <span class="pre">is2pow(unsigned</span> <span class="pre">int</span> <span class="pre">n):</span></code>.</p>
</div>
<div class="section" id="interrupt-and-signal-handling">
<span id="section-interrupt"></span><h2>Interrupt and Signal Handling<a class="headerlink" href="#interrupt-and-signal-handling" title="Permalink to this headline">¶</a></h2>
<p>When writing Cython code for Sage, special care must be taken to ensure
that the code can be interrupted with <code class="docutils literal notranslate"><span class="pre">CTRL-C</span></code>.</p>
<p>Sage uses the <a class="reference external" href="https://github.com/sagemath/cysignals">cysignals package</a>
for this, see the <a class="reference external" href="http://cysignals.readthedocs.org/">cysignals documentation</a>
for more information.</p>
</div>
<div class="section" id="unpickling-cython-code">
<h2>Unpickling Cython Code<a class="headerlink" href="#unpickling-cython-code" title="Permalink to this headline">¶</a></h2>
<p>Pickling for Python classes and extension classes, such as Cython, is different.
This is discussed in the <a class="reference external" href="http://docs.python.org/library/pickle.html#pickle-protocol">Python pickling documentation</a>. For the unpickling of
extension classes you need to write a <code class="xref py py-meth docutils literal notranslate"><span class="pre">__reduce__()</span></code> method which typically
returns a tuple <code class="docutils literal notranslate"><span class="pre">(f,</span> <span class="pre">args,</span> <span class="pre">...)</span></code> such that <code class="docutils literal notranslate"><span class="pre">f(*args)</span></code> returns (a copy of) the
original object. As an example, the following code snippet is the
<code class="xref py py-meth docutils literal notranslate"><span class="pre">__reduce__()</span></code> method from
<a class="reference external" href="../reference/rings_standard/sage/rings/integer.html#sage.rings.integer.Integer" title="(in Sage Reference Manual: Standard Commutative Rings v8.4)"><code class="xref py py-class docutils literal notranslate"><span class="pre">sage.rings.integer.Integer</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">__reduce__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This is used when pickling integers.</span>

<span class="sd">    EXAMPLES::</span>

<span class="sd">        sage: n = 5</span>
<span class="sd">        sage: t = n.__reduce__(); t</span>
<span class="sd">        (&lt;cyfunction make_integer at ...&gt;, (&#39;5&#39;,))</span>
<span class="sd">        sage: t[0](*t[1])</span>
<span class="sd">        5</span>
<span class="sd">        sage: loads(dumps(n)) == n</span>
<span class="sd">        True</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># This single line below took me HOURS to figure out.</span>
    <span class="c1"># It is the *trick* needed to pickle Cython extension types.</span>
    <span class="c1"># The trick is that you must put a pure Python function</span>
    <span class="c1"># as the first argument, and that function must return</span>
    <span class="c1"># the result of unpickling with the argument in the second</span>
    <span class="c1"># tuple as input. All kinds of problems happen</span>
    <span class="c1"># if we don&#39;t do this.</span>
    <span class="k">return</span> <span class="n">sage</span><span class="o">.</span><span class="n">rings</span><span class="o">.</span><span class="n">integer</span><span class="o">.</span><span class="n">make_integer</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">str</span><span class="p">(</span><span class="mi">32</span><span class="p">),)</span>
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Coding in Cython</a><ul>
<li><a class="reference internal" href="#writing-cython-code-in-sage">Writing Cython Code in Sage</a></li>
<li><a class="reference internal" href="#attaching-or-loading-spyx-files">Attaching or Loading .spyx Files</a></li>
<li><a class="reference internal" href="#interrupt-and-signal-handling">Interrupt and Signal Handling</a></li>
<li><a class="reference internal" href="#unpickling-cython-code">Unpickling Cython Code</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="coding_in_python.html"
                        title="previous chapter">Coding in Python for Sage</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="coding_in_other.html"
                        title="next chapter">Using External Libraries and Interfaces</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/coding_in_cython.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="coding_in_other.html" title="Using External Libraries and Interfaces"
             >next</a> |</li>
        <li class="right" >
          <a href="coding_in_python.html" title="Coding in Python for Sage"
             >previous</a> |</li>
  
    
      <a href="../index.html"><img src="_static/logo_sagemath_black.svg" height="28" style="vertical-align: middle" title="Sage Logo"></a>
    
  
  
        <li class="nav-item nav-item-0"><a href="index.html">Developer&#39;s Guide v8.4</a> &#187;</li>
 
      </ul>
    </div>
    
    <div class="footer" role="contentinfo">
        &#169; Copyright 2005--2018, The Sage Development Team.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.6.
    </div>
    <script type="text/javascript">
/*global jQuery, window */
/* Sphinx sidebar toggle.  Putting this code at the end of the body
 * enables the toggle for the live, static, and offline docs.  Note:
 * sage.misc.html.math_parse() eats jQuery's dollar-sign shortcut. */
var jq = jQuery;
jq(document).ready(function () {
    var bar, bod, bg, fg, key, tog, wid_old, wid_new, resize, get_state, set_state;
    bod = jq('div.bodywrapper');
    bar = jq('div.sphinxsidebar');
    tog = jq('<div class="sphinxsidebartoggle"></div>');

    /* Delayed resize helper.  Not perfect but good enough. */
    resize = function () {
        setTimeout(function () {
            tog.height(bod.height());
        }, 100);
    };
    jq(window).resize(function () {
        resize();
    });

    /* Setup and add the toggle. See Sphinx v0.5.1 default.css. */
    fg = jq('div.sphinxsidebar p a').css('color') || 'rgb(152, 219, 204)';
    bg = jq('div.document').css('background-color') || 'rgb(28, 78, 99)';
    wid_old = '230px';
    wid_new = '5px';
    tog.css('background-color', bg)
        .css('border-width', '0px')
        .css('border-right', wid_new + ' ridge ' + bg)
        .css('cursor', 'pointer')
        .css('position', 'absolute')
        .css('left', '-' + wid_new)
        .css('top', '0px')
        .css('width', wid_new);
    bod.css('position', 'relative');
    bod.prepend(tog);
    resize();

    /* Cookie helpers. */
    key = 'sphinxsidebar=';
    set_state = function (s) {
        var date = new Date();
        /* Expiry in 7 days. */
        date.setTime(date.getTime() + (7 * 24 * 3600 * 1000));
        document.cookie = key + encodeURIComponent(s) + '; expires=' +
            date.toUTCString() + '; path=/';
    };
    get_state = function () {
        var i, c, crumbs = document.cookie.split(';');
        for (i = 0; i < crumbs.length; i += 1) {
            c = crumbs[i].replace(/^\s+/, '');
            if (c.indexOf(key) === 0) {
                return decodeURIComponent(c.substring(key.length, c.length));
            }
        }
        return null;
    };

    /* Event handlers. */
    tog.mouseover(function (ev) {
        tog.css('border-right-color', fg);
    }).mouseout(function (ev) {
        tog.css('border-right-color', bg);
    }).click(function (ev) {
        if (bod.hasClass('wide')) {
            bod.removeClass('wide');
            bod.css('margin-left', wid_old);
            bar.css('width', wid_old);
            bar.show();
            set_state('visible');
        } else {
            set_state('hidden');
            bar.hide();
            bar.css('width', '0px');
            bod.css('margin-left', wid_new);
            bod.addClass('wide');
        }
        resize();
    });

    /* Hide the normally visible sidebar? */
    if (get_state() === 'hidden') {
        tog.trigger('click');
    } else {
        set_state('visible');
    }
});
    </script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-66100-14', 'auto');
  ga('send', 'pageview');
</script>
  </body>
</html>